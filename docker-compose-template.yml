#docker-compose模板
#默认三个数据库都会启动，不需要可以删除相关的服务，同时在backend和celery-worker的启动依赖中删除相关的服务
services:
  base:
    build:
      context: ./server
      dockerfile: docker/Dockerfile
    image: software-base:latest  # 指定镜像名称和标签
  front:
    build:
      context: ./web  # 构建上下文为当前目录[citation:1]
      dockerfile: docker/Dockerfile  # 指定 Dockerfile 路径[citation:6]
    image: vue-app:1.0  # 支持环境变量设置标签[citation:4]
    container_name: software-web
    ports:
      - "80:80"  # 主机端口:容器端口[citation:1]
    networks:
      - vue-network
    restart: unless-stopped  # 自动重启策略[citation:7]
    environment:
      - NODE_ENV=production
    volumes:
      # 挂载日志文件（可选）
      - vue-logs:/var/log/nginx
    depends_on:
      - backend  # 定义服务依赖关系[citation:6]

  # 如果需要后端 API，可以在这里添加
  backend:
    build:
      context: ./server
      dockerfile: docker/server/Dockerfile
      cache_from:
        - software-base:latest
    image: server:1.0
    container_name: software-server
    environment:
      - FLASK_ENV=production
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USER=root
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=app_db
      - MYSQL_PORT=${MYSQL_PORT}
      - GS_PORT=5432
      - GS_PASSWORD=${GS_PASSWORD}
      - GS_USERNAME=gaussdb
      - GS_DATABASE=postgres
      - GS_HOST=opengauss_db

      - DATABASE=${DATABASE}

      - DIFY_API_URL=${DIFY_API_URL}
      - DIFY_API_KEY=${DIFY_API_KEY}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    networks:
      - vue-network
    restart: unless-stopped  # 自动重启策略[citation:7]
    volumes:
      - uploads_volume:/app/uploads
    depends_on:

      - opengauss_db







  opengauss_db:
    image: opengauss/opengauss:7.0.0-RC2.B015-openEuler22.03
    container_name: software-opengauss
    restart: always
    environment:
      - GS_PASSWORD=${GS_PASSWORD}
      - GS_PORT=5432
      - TZ=Asia/Shanghai
      - GAUSSDATA=/var/lib/opengauss/data  # 数据目录
      - GAUSSLOG=/var/lib/opengauss/log   # 日志目录
    volumes:
      - opengauss_data:/var/lib/opengauss
    privileged: true
    # 为容器分配足够的内存
    shm_size: '512MB'

    networks:
      - vue-network


  redis:
    image: redis:7-alpine
    container_name: software_redis
    # ports:
    #   - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - vue-network
  celery-worker:
    build:
      context: ./server
      dockerfile: docker/celery/Dockerfile
      cache_from:
        - software-base:latest
    container_name: pullup_celery_worker
    environment:
      - FLASK_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
      - opengauss_db

    restart: always

    volumes:
      - uploads_volume:/app/uploads  # 与Web服务共享上传目录
      - logs_volume:/app/logs
    networks:
      - vue-network
networks:
  # create a network between sandbox, api and ssrf_proxy, and can not access outside.

  vue-network:
    driver: bridge  # 使用桥接网络[citation:6]
    ipam:
      config:
        - subnet: 172.18.0.0/16  # 使用桥接网络[citation:6]

volumes:
  vue-logs:
  mysql_data:
  opengauss_data:
  uploads_volume:
  redis_data:
  logs_volume:
  oceanbase_data:

